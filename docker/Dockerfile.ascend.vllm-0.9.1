# 1. Base Image
FROM swr.cn-south-1.myhuaweicloud.com/ascendhub/cann:8.2.rc1-910b-ubuntu22.04-py3.11

# 2. Pre-installation foundation vllm with architecture echo
RUN echo "[LOG INFO]Current system architecture check" && \
    arch=$(uname -m) && \
    echo "[LOG INFO]Detected architecture: $arch" && \

# 3. Install vllm
RUN  git clone --depth 1 --branch v0.9.1 https://github.com/vllm-project/vllm \
    && if [ "$arch" = "x86_64" ]; then \
         echo "[LOG INFO]Entering x86_64 branch: Setting pip extra index url"; \
         pip config set global.extra-index-url "https://download.pytorch.org/whl/cpu/ https://mirrors.huaweicloud.com/ascend/repos/pypi"; \
       else \
         echo "[LOG INFO]Entering non-x86_64 branch: No extra pip index url set"; \
       fi \
    && cd vllm \
    && VLLM_TARGET_DEVICE=empty pip install -v -e . \
    && cd ..

# 4. Install vllm_ascend
RUN git clone --depth 1 --branch v0.9.1 https://github.com/vllm-project/vllm-ascend.git \
    && cd vllm-ascend \
    && arch=$(uname -m) && \
    echo "[LOG INFO]Configuring LD_LIBRARY_PATH for $arch" && \
    if [ "$arch" = "aarch64" ]; then \
         export LD_LIBRARY_PATH=/usr/local/Ascend/ascend-toolkit/8.2.RC1/aarch64-linux/devlib/linux/aarch64:$LD_LIBRARY_PATH; \
       elif [ "$arch" = "x86_64" ]; then \
         export LD_LIBRARY_PATH=/usr/local/Ascend/ascend-toolkit/8.2.RC1/x86_64-linux/devlib/linux/x86_64/:$LD_LIBRARY_PATH; \
       fi \
    && source /usr/local/Ascend/ascend-toolkit/set_env.sh \
    && source /usr/local/Ascend/nnal/atb/set_env.sh \
    && pip install -v -e . \
    && cd ..

# 5. Install verl
RUN git clone https://github.com/volcengine/verl.git \
    && cd verl \
    && git checkout main \
    && pip install -r requirements-npu.txt \
    && pip install -e . \
    && cd ..

# 6. Install MindSpeed
RUN git clone https://gitee.com/ascend/MindSpeed.git \
    && pip install -e MindSpeed

# 7. Install Megatron-LM and configure PYTHONPATH
RUN git clone https://github.com/NVIDIA/Megatron-LM.git \
    && cd Megatron-LM \
    && git checkout core_v0.12.1 \
    && cd .. \
    && echo "export PYTHONPATH=\$PYTHONPATH:/Megatron-LM" >> ~/.bashrc

# Clear pip cache to reduce image size
RUN pip cache purge

# Setting Default Commands
CMD ["/bin/bash"]
